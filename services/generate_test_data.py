#!/usr/bin/env python3
"""
Script de g√©n√©ration de donn√©es de test pour tester la coordination entre microservices
"""

import requests
import json
import time
from faker import Faker
import random

fake = Faker("fr_FR")

# URLs des services
SERVICES = {
    "products": "http://localhost:8001",
    "stores": "http://localhost:8002",
    "sales": "http://localhost:8003",
    "stock": "http://localhost:8004",
    "reporting": "http://localhost:8005",
    "customers": "http://localhost:8006",
    "cart": "http://localhost:8007",
    "orders": "http://localhost:8008",
}


def wait_for_services():
    """Attendre que tous les services soient pr√™ts"""
    print("üîÑ V√©rification de l'√©tat des services...")
    for name, url in SERVICES.items():
        max_retries = 10
        for i in range(max_retries):
            try:
                response = requests.get(f"{url}/health", timeout=5)
                if response.status_code == 200:
                    print(f"‚úÖ {name} service ready")
                    break
            except requests.exceptions.RequestException:
                if i == max_retries - 1:
                    print(f"‚ùå {name} service not ready after {max_retries} attempts")
                    return False
                time.sleep(2)
    return True


def create_categories():
    """Cr√©er des cat√©gories de produits"""
    print("\nüìÅ Cr√©ation des cat√©gories...")
    categories = [
        {"name": "√âlectronique", "description": "Produits √©lectroniques"},
        {"name": "V√™tements", "description": "V√™tements et accessoires"},
        {"name": "Maison", "description": "Articles pour la maison"},
        {"name": "Sports", "description": "√âquipements sportifs"},
        {"name": "Livres", "description": "Livres et magazines"},
    ]

    created_categories = []
    for cat in categories:
        try:
            response = requests.post(
                f"{SERVICES['products']}/api/v1/categories", json=cat
            )
            if response.status_code == 201:
                created_cat = response.json()
                created_categories.append(created_cat)
                print(
                    f"‚úÖ Cat√©gorie cr√©√©e: {created_cat['name']} (ID: {created_cat['id']})"
                )
            else:
                print(f"‚ùå Erreur cr√©ation cat√©gorie {cat['name']}: {response.text}")
        except Exception as e:
            print(f"‚ùå Erreur: {e}")

    return created_categories


def create_products(categories):
    """Cr√©er des produits"""
    print("\nüì¶ Cr√©ation des produits...")
    products_data = [
        {
            "name": "iPhone 15",
            "description": "Smartphone Apple",
            "price": 899.99,
            "category": "√âlectronique",
        },
        {
            "name": "MacBook Pro",
            "description": "Ordinateur portable",
            "price": 1999.99,
            "category": "√âlectronique",
        },
        {
            "name": "T-shirt Nike",
            "description": "T-shirt de sport",
            "price": 29.99,
            "category": "V√™tements",
        },
        {
            "name": "Jean Levi's",
            "description": "Jean classique",
            "price": 79.99,
            "category": "V√™tements",
        },
        {
            "name": "Cafeti√®re",
            "description": "Cafeti√®re √©lectrique",
            "price": 49.99,
            "category": "Maison",
        },
        {
            "name": "Ballon de foot",
            "description": "Ballon officiel",
            "price": 19.99,
            "category": "Sports",
        },
        {
            "name": "Livre Python",
            "description": "Guide de programmation",
            "price": 39.99,
            "category": "Livres",
        },
    ]

    # Mapper les cat√©gories par nom
    cat_map = {cat["name"]: cat["id"] for cat in categories}

    created_products = []
    for prod in products_data:
        product = {
            "name": prod["name"],
            "description": prod["description"],
            "price": prod["price"],
            "category_id": cat_map.get(prod["category"], categories[0]["id"]),
        }

        try:
            response = requests.post(
                f"{SERVICES['products']}/api/v1/products", json=product
            )
            if response.status_code == 201:
                created_prod = response.json()
                created_products.append(created_prod)
                print(
                    f"‚úÖ Produit cr√©√©: {created_prod['name']} (ID: {created_prod['id']}) - {created_prod['price']}‚Ç¨"
                )
            else:
                print(f"‚ùå Erreur cr√©ation produit {prod['name']}: {response.text}")
        except Exception as e:
            print(f"‚ùå Erreur: {e}")

    return created_products


def create_stores():
    """Cr√©er des magasins"""
    print("\nüè™ Cr√©ation des magasins...")
    stores_data = [
        {
            "name": "Store Paris Centre",
            "address": "123 Rue de Rivoli, Paris",
            "city": "Paris",
        },
        {
            "name": "Store Lyon",
            "address": "45 Rue de la R√©publique, Lyon",
            "city": "Lyon",
        },
        {
            "name": "Store Marseille",
            "address": "78 Cours Belsunce, Marseille",
            "city": "Marseille",
        },
    ]

    created_stores = []
    for store in stores_data:
        try:
            response = requests.post(f"{SERVICES['stores']}/api/v1/stores", json=store)
            if response.status_code == 201:
                created_store = response.json()
                created_stores.append(created_store)
                print(
                    f"‚úÖ Magasin cr√©√©: {created_store['name']} (ID: {created_store['id']})"
                )
            else:
                print(f"‚ùå Erreur cr√©ation magasin {store['name']}: {response.text}")
        except Exception as e:
            print(f"‚ùå Erreur: {e}")

    return created_stores


def create_stock_entries(products, stores):
    """Cr√©er des entr√©es de stock"""
    print("\nüìä Cr√©ation des stocks...")

    for product in products:
        for store in stores:
            quantity = random.randint(10, 100)
            stock_entry = {
                "product_id": product["id"],
                "store_id": store["id"],
                "quantity": quantity,
                "reserved_quantity": 0,
            }

            try:
                response = requests.post(
                    f"{SERVICES['stock']}/api/v1/stock", json=stock_entry
                )
                if response.status_code == 201:
                    print(
                        f"‚úÖ Stock cr√©√©: {product['name']} √† {store['name']} - {quantity} unit√©s"
                    )
                else:
                    print(f"‚ùå Erreur cr√©ation stock: {response.text}")
            except Exception as e:
                print(f"‚ùå Erreur: {e}")


def create_customers():
    """Cr√©er des clients"""
    print("\nüë§ Cr√©ation des clients...")
    customers_data = []

    for i in range(5):
        customer = {
            "email": fake.email(),
            "password": "password123",
            "first_name": fake.first_name(),
            "last_name": fake.last_name(),
            "phone": fake.phone_number(),
        }
        customers_data.append(customer)

        try:
            response = requests.post(
                f"{SERVICES['customers']}/api/v1/auth/register", json=customer
            )
            if response.status_code == 201:
                created_customer = response.json()
                print(
                    f"‚úÖ Client cr√©√©: {customer['first_name']} {customer['last_name']} ({customer['email']})"
                )

                # Ajouter une adresse
                address = {
                    "street": fake.street_address(),
                    "city": fake.city(),
                    "postal_code": fake.postcode(),
                    "country": "France",
                    "is_default": True,
                }

                # R√©cup√©rer le token pour cr√©er l'adresse
                login_response = requests.post(
                    f"{SERVICES['customers']}/api/v1/auth/login",
                    json={"email": customer["email"], "password": customer["password"]},
                )

                if login_response.status_code == 200:
                    token = login_response.json()["access_token"]
                    headers = {"Authorization": f"Bearer {token}"}

                    addr_response = requests.post(
                        f"{SERVICES['customers']}/api/v1/addresses",
                        json=address,
                        headers=headers,
                    )
                    if addr_response.status_code == 201:
                        print(f"  üìç Adresse ajout√©e: {address['city']}")

            else:
                print(f"‚ùå Erreur cr√©ation client: {response.text}")
        except Exception as e:
            print(f"‚ùå Erreur: {e}")

    return customers_data


def test_cart_workflow(products, customers_data):
    """Tester le workflow panier -> commande"""
    print("\nüõí Test du workflow panier -> commande...")

    if not customers_data or not products:
        print("‚ùå Pas de clients ou produits disponibles")
        return

    customer = customers_data[0]

    # Login du client
    try:
        login_response = requests.post(
            f"{SERVICES['customers']}/api/v1/auth/login",
            json={"email": customer["email"], "password": customer["password"]},
        )

        if login_response.status_code != 200:
            print(f"‚ùå Erreur login: {login_response.text}")
            return

        token = login_response.json()["access_token"]
        headers = {"Authorization": f"Bearer {token}"}

        # Cr√©er un panier
        cart_response = requests.post(
            f"{SERVICES['cart']}/api/v1/carts",
            json={"customer_id": login_response.json()["customer"]["id"]},
        )

        if cart_response.status_code != 201:
            print(f"‚ùå Erreur cr√©ation panier: {cart_response.text}")
            return

        cart = cart_response.json()
        print(f"‚úÖ Panier cr√©√© (ID: {cart['id']})")

        # Ajouter des produits au panier
        selected_products = random.sample(products, min(3, len(products)))

        for product in selected_products:
            quantity = random.randint(1, 3)
            item_data = {"product_id": product["id"], "quantity": quantity}

            item_response = requests.post(
                f"{SERVICES['cart']}/api/v1/carts/{cart['id']}/items", json=item_data
            )

            if item_response.status_code == 201:
                print(f"‚úÖ Produit ajout√© au panier: {product['name']} x{quantity}")
            else:
                print(f"‚ùå Erreur ajout produit: {item_response.text}")

        # R√©cup√©rer le panier mis √† jour
        cart_get_response = requests.get(
            f"{SERVICES['cart']}/api/v1/carts/{cart['id']}"
        )
        if cart_get_response.status_code == 200:
            updated_cart = cart_get_response.json()
            print(f"üí∞ Total panier: {updated_cart['total_amount']}‚Ç¨")

        # Passer commande
        print("\nüì¶ Passage de commande...")
        order_data = {
            "cart_id": cart["id"],
            "shipping_address": {
                "street": "123 Test Street",
                "city": "Paris",
                "postal_code": "75001",
                "country": "France",
            },
            "billing_address": {
                "street": "123 Test Street",
                "city": "Paris",
                "postal_code": "75001",
                "country": "France",
            },
        }

        order_response = requests.post(
            f"{SERVICES['orders']}/api/v1/orders", json=order_data, headers=headers
        )

        if order_response.status_code == 201:
            order = order_response.json()
            print(
                f"‚úÖ Commande cr√©√©e (ID: {order['id']}) - Total: {order['total_amount']}‚Ç¨"
            )

            # V√©rifier l'impact sur le stock
            print("\nüìä V√©rification impact sur le stock...")
            for item in updated_cart.get("items", []):
                product_id = item["product_id"]
                quantity_ordered = item["quantity"]

                # V√©rifier le stock apr√®s commande
                stock_response = requests.get(f"{SERVICES['stock']}/api/v1/stock")
                if stock_response.status_code == 200:
                    stocks = stock_response.json()
                    for stock in stocks:
                        if stock["product_id"] == product_id:
                            print(
                                f"üì¶ Stock {product_id}: {stock['quantity']} disponible, {stock.get('reserved_quantity', 0)} r√©serv√©"
                            )

        else:
            print(f"‚ùå Erreur cr√©ation commande: {order_response.text}")

    except Exception as e:
        print(f"‚ùå Erreur workflow: {e}")


def check_data_coordination():
    """V√©rifier la coordination des donn√©es entre services"""
    print("\nüîç V√©rification de la coordination des donn√©es...")

    try:
        # V√©rifier les produits
        products_response = requests.get(f"{SERVICES['products']}/api/v1/products")
        if products_response.status_code == 200:
            products = products_response.json()
            print(f"üì¶ {len(products)} produits dans Products API")

        # V√©rifier le stock
        stock_response = requests.get(f"{SERVICES['stock']}/api/v1/stock")
        if stock_response.status_code == 200:
            stocks = stock_response.json()
            print(f"üìä {len(stocks)} entr√©es de stock dans Stock API")

        # V√©rifier les clients
        try:
            customers_response = requests.get(
                f"{SERVICES['customers']}/api/v1/customers"
            )
            if customers_response.status_code == 200:
                customers = customers_response.json()
                print(f"üë§ {len(customers)} clients dans Customers API")
        except:
            print("üë§ Customers API n√©cessite une authentification")

        # V√©rifier les magasins
        stores_response = requests.get(f"{SERVICES['stores']}/api/v1/stores")
        if stores_response.status_code == 200:
            stores = stores_response.json()
            print(f"üè™ {len(stores)} magasins dans Stores API")

        print("\n‚úÖ Coordination des donn√©es v√©rifi√©e!")

    except Exception as e:
        print(f"‚ùå Erreur v√©rification: {e}")


def main():
    """Fonction principale"""
    print("üöÄ G√©n√©ration de donn√©es de test pour les microservices")
    print("=" * 60)

    if not wait_for_services():
        print("‚ùå Certains services ne sont pas pr√™ts")
        return

    # G√©n√©ration des donn√©es
    categories = create_categories()
    products = create_products(categories)
    stores = create_stores()
    create_stock_entries(products, stores)
    customers_data = create_customers()

    # Test des workflows
    test_cart_workflow(products, customers_data)

    # V√©rification finale
    check_data_coordination()

    print("\nüéâ G√©n√©ration de donn√©es termin√©e!")
    print("=" * 60)


if __name__ == "__main__":
    main()
